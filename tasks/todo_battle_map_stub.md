# TODO — バトルマップ画面の叩き (2025-09-27)

## 概要
- FE風シミュレーションバトル用の「マップ画面」の叩きを追加する。
- ユニット一覧（キャラクター一覧）からボタンで遷移できる簡易デモ画面。

## 要件
- FE風シミュレーションバトル用のマップ画面の叩きを作成。
- キャラクター一覧からボタンで遷移可能（右上付近に新規ボタン）。
- マップデータは JSON のレイヤー配列で管理：
  1) 平地（茶色タイル） 2) 森（緑タイル） 3) 砦（黄色タイル）。
- `db/user/usr_characters.json` のキャラクターから配置：
  - 味方ユニット 1 体 → マップ下側（中央付近）。
  - 敵ユニット 2 体 → マップ上側（左右に分ける）。

## 受け入れ基準
- 一覧画面に「マップ叩き」ボタンが表示され、押下で新画面へ遷移できる。
- マップ画面に 10×8 程度のグリッドが描画される。
  - 平地=茶系（例: RGBA(150,120,80)）、森=緑系（例: RGBA(60,120,60)）、砦=黄系（例: RGBA(170,150,40)）。
  - レイヤー合成は「平地→森→砦」の優先度（砦>森>平地）。
- ユーザデータからユニットを読み、味方1体を下中央、敵2体を上左右に配置してプレースホルダ（丸/四角+頭文字）で描画。
- `Esc` または 画面上の「＜ 一覧へ」ボタンで一覧に戻れる。
- マップJSONが読み込めない場合は画面内に簡易エラー表示。

## 実装方針（最小）
- 画面: `internal/ui/screens/battlemap.go` に新規（描画＋イベント最小）。
- 遷移: 一覧画面（`internal/ui/screens/list.go`）に「マップ叩き」ボタンを追加。
  - ボタン矩形/描画は `internal/ui/widgets/buttons.go` に `MapDemoButtonRect/DrawMapDemoButton` を追加。
  - API 経由で呼べるよう `internal/ui/api.go` に薄いラッパーを追加。
- データ: マップ定義はマスタ扱い。
  - 追加ファイル（例）: `db/master/mst_map_demo.json`（下記スキーマ）。
  - ローダー: `internal/model/map.go` に `type MapData` と JSON ロード関数を追加。
- ユニット選定: `db/user/usr_characters.json` の先頭から
  - 1番目→味方、2番目・3番目→敵。存在しなければサンプルユニットでフォールバック。
- 描画: タイルは `vector.DrawFilledRect` で色塗り。ユニットは小さな円/四角と縮小してユニットの画像。
- テスト: `testdata/map/mst_map_demo.json` を用意し JSON ロードの最小テストを追加。

## マップJSON仕様（暫定）
- ファイル: `db/master/mst_map_demo.json`
- スキーマ（各レイヤーは 0/1 の 2次元配列）:

```json
{
  "name": "demo_field",
  "width": 8,
  "height": 6,
  "layers": {
    "ground": [[1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1]],
    "forest": [[0,0,0,0,0,0,0,0],[0,0,1,1,1,0,0,0],[0,0,1,0,1,0,0,0],[0,0,1,1,1,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]],
    "fort":   [[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,1,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]]
  }
}
```

## 操作（叩き）
- キー: `Esc`/`X`=戻る。`Z/Enter`=未使用（今は表示のみ）。
- マウス: クリックは未使用（任意・後続）。

## ドキュメント/命名
- マスタは `mst_*`、ユーザは `usr_*` 接頭辞（既存規約に準拠）。
- 型・関数を追加した場合は `docs/API.md` に追記。DB 仕様変更は `docs/DB_NOTES.md` を更新。

