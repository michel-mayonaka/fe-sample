# 03_方針決定と後続タスクの整理

ステータス: [完了]
担当: @tkg-engineer
開始: 2025-11-17 02:13:34 +0900

## 目的
- `apply.go` 分割の最終方針を決定し、実装を行うかどうか、行う場合はどのようなステップ/ストーリーで進めるかを整理する。

## 完了条件（DoD）
- [x] 分割を実施するか否かの結論と、その理由がまとめられている。
- [x] 分割を実施する場合の大まかなステップ（フェーズ分けや影響範囲）が箇条書きで整理されている。
- [x] 必要に応じて、新しい実装用ストーリーまたは Backlog エントリが作成され、関連リンクが追記されている。

## 作業手順（概略）
- `02_分割方針の検討` の結果をレビューし、採用案を決定する。
- 実装の規模に応じて、「このストーリー内で軽めに対応する」か「別ストーリーとして切り出す」かを判断する。
- Backlog/Stories/Discovery の関連を整理し、将来の自分や他の開発者が辿れるようにリンクを整備する。

## 進捗ログ
- 2025-11-17 02:13:34 +0900: タスク作成。
- 2025-11-19 01:00:12 +0900: 分割案をレビューし、後続の実装方針/Backlog を整理。
- 2025-11-19 01:05:44 +0900: Backlog へ実装エントリを追加し、決定事項をドキュメント化。DoD を満たしたため完了。

## 依存／ブロッカー
- `02_分割方針の検討 — ファイル構成と責務再配置案` の完了。

## 成果物リンク
- Backlog: stories/BACKLOG.md（`[P1] 2025-11-19: ApplyMetrics 分割実装`）
- 決定メモ: stories/20251117-ui-apply-split/tasks/03_followups-and-backlog.md

## 決定事項
- **方針**: 案A（`apply.go` を API ラッパに残し、ドメイン別 `apply_*.go` へロジックを分割）を採用。実装は別ストーリーで対応し、今回ストーリーでは調査/設計に留める。
- **理由**
  - コンフリクト削減: List/Status/Sim など個別領域の改修が多く、ファイル分割で差分衝突を緩和できる。
  - 可読性向上: 各画面のメトリクスが独立し、レビュー範囲を明確化できる。
  - テスト容易化: `metricsTargets` や共通ヘルパ導入により、将来的に単体テストで各領域を個別検証しやすくなる。
  - 既存 API 維持: 呼び出し元変更を避け、docs/API.md の整合性を保てる。

## 実装ステップ（推奨）
1. `apply_helpers.go` を追加し、`assignPositive`/`copyInts`/`metricsTargets` などの共通処理を集約。
2. `apply.go` 内のロジックを段階的に `apply_list.go` / `apply_status.go` / `apply_sim.go` / `apply_popup.go` / `apply_widgets.go` へ移し、`ApplyMetrics` は各関数の呼び出しに専念させる。
3. `apply_test.go` を拡張し、ドメイン別の適用テストと `metricsTargets` のモックテストを追加。
4. ドキュメント更新: `docs/API.md` と `docs/ARCHITECTURE.md` に「実装が複数ファイルへ分割された」旨を追記し、参照パスを最新化。
5. 移行後に `make mcp` を通し、UI ホットリロード経路（`internal/game/app/game.go`, `core.go`）でリグレッションが無いことを確認。

## Backlog/フォローアップ
- `[P1] 2025-11-19: ApplyMetrics 分割実装` を stories/BACKLOG.md に追加。実装ストーリー化時は `make new-story SLUG=ui-apply-refactor` などで昇格する。
- 当面は調査ストーリーを完了扱いとし、実装は Backlog から別ストーリーへ移行する。
