# pkg/game 再利用要件メモ

作成日: 2025-11-17
ストーリー: stories/20250929-pkg-game-visibility/README.md

## 1. 現状の役割と設計意図

- `docs/architecture/README.md` では `pkg/game` を「ドメインロジック（テスト対象）」として、UI やインフラから切り離した公開層に置く方針が記載されている。
- 現在 `pkg/game` 配下には、主に次のサブドメインが含まれる。
  - 戦闘ロジック本体: `pkg/game`（`Unit/Stats/Weapon/Terrain` と `Forecast*/Resolve*/AttackSpeed/DoubleAdvantage` 等）
  - 幾何ユーティリティ: `pkg/game/geom`（矩形内判定など、UI 非依存のロジック）
  - 入力ドメイン: `pkg/game/input`（Action/ControlState/Layout/Reader/Source 等の抽象入力）
- いずれも I/O や UI フレームワークに依存しない純粋ロジックであり、「再利用しやすくテストしやすいコア」を `pkg/` にまとめる設計になっている。
- 現時点での実際の利用者は、同一リポジトリ内の `internal/usecase` と `internal/game/scenes`/`internal/game/ui`/`internal/game/provider` のみであり、外部モジュールからの import 実績はない。

## 2. 想定コンシューマ候補

現時点で明示的な利用者は UI サンプル内だけだが、設計意図と構成から将来の主な再利用候補を次のように想定する。

1. 同一リポジトリ内の別バイナリ
   - 例: 戦闘シミュレーション専用の CLI ツール、バランス検証用ツール、テスト専用 Runner など。
   - 期待する役割: `pkg/game` を直接 import し、UI に依存しない形で戦闘予測・解決ロジックを呼び出す。

2. 将来のサーバサイド/バックエンドサービス
   - 例: オンライン対戦やランキング計算のためのバトルサーバ、リプレイ検証サービスなど。
   - 期待する役割: HTTP/gRPC 等のフロントから受け取った DTO を `pkg/game.Unit` 等に変換し、共通の戦闘ロジックを用いて結果を計算する。

3. バランス調整・運用ツール
   - 例: スプレッドシートや外部ツールと連携した大量試行シミュレータ、パラメータ調整用のオフラインツール。
   - 期待する役割: `ForecastAt` や `ForecastAtExplain` を用いて「このパラメータなら命中/与ダメがどう変化するか」を統一仕様で確認する。

4. 別リポジトリからの参照
   - 例: 将来 UI サンプルからドメインロジックを分離し、ライブラリ的に流用するプロジェクト。
   - 期待する役割: `ui_sample` モジュールを依存に追加し、`ui_sample/pkg/game` を直接 import してドメインロジックのみを再利用する。

## 3. 安定 API 範囲のラフ案

上記のコンシューマが依存するであろう「安定 API」の候補を、現行設計から切り出すと次のようになる。

- コア型
  - `Stats`, `Weapon`, `Unit`, `Terrain`, `ForecastResult`, `ForecastBreakdown`
  - `TriangleRelation`（および定数: `TriangleNeutral/Advantage/Disadvantage`）
- コア関数
  - 予測系: `Forecast`, `ForecastAt`, `ForecastAtExplain`
  - 解決系: `ResolveRoundAt`（および関連の補助関数があれば将来追加）
  - 速度/追撃: `AttackSpeed`, `DoubleAdvantage`
  - 相性/地形表示: `TriangleRelationOf`, `TerrainPresetName`
- 入力ドメイン (`pkg/game/input`)
  - `Action`, `ControlState`, `Event`, `Layout`, `Reader`, `Source` など「UI フレームワークに依存しない抽象入力」の型とインターフェース。
- 幾何ユーティリティ (`pkg/game/geom`)
  - `RectContains` など、UI によらず座標系の前提が変わらない小さな関数群。

安定 API として扱う場合の前提:

- 型のフィールド追加は許容するが、既存フィールドの削除や意味の大きな変更は Story/Spec レベルの合意が必要。
- 関数のシグネチャ変更（引数/戻り値の追加・削除）は互換性破壊として扱う。
- 挙動の変更は `docs/SPECS/gameplay/battle_basic.md` 等のドメイン仕様と整合をとったうえで行い、`pkg/game` のテストで後方互換性を確認する。

## 4. バージョニング/互換性ポリシー（案）

現状モジュール `ui_sample` はライブラリ配布を前提にしていないが、`pkg/game` を「準ライブラリ」と見なす場合の運用イメージを整理する。

- 外部コンシューマから見た前提
  - `go.mod` で `ui_sample` を依存に追加し、タグ/ブランチでバージョンを固定する運用を想定。
  - `pkg/game` の API 変更は、タグレベルでのバージョンアップとセットで追従してもらう。
- リポジトリ側の運用
  - `pkg/game` に互換性を破る変更を入れる場合は、必ず専用ストーリーを切り、Pros/Cons と影響範囲をドキュメント化する。
  - `Forecast*`/`Resolve*`/`DoubleAdvantage` 等の中核 API については「後方互換を守る」ことを基本方針とし、単純なバグ修正やパラメータ調整も `stories/finish/20250930-battle-notes-archive` 等の仕様メモと合わせて更新する。
  - `pkg/game/input` や `geom` は比較的薄いレイヤのため、必要に応じてフィールド追加や列挙追加を行うが、その場合もゼロ値安全性を維持する。

## 5. 暫定方針（公開維持か内部専用か）

- 現時点で外部モジュールからの import 実績は無く、「実際の利用者」は UI サンプル内に限定されている。
- 一方で、戦闘ロジックや入力ドメインは UI/インフラから明確に切り出されており、将来の CLI/サーバ/ツールからの再利用シナリオは自然に想定できる。
- `internal` 配下へ移動すると、Go の可視性ルールにより「別モジュールからの再利用」ができなくなり、将来のライブラリ化や分離の柔軟性が下がる。
- テスト容易性の観点では、`pkg/` でも `internal/` でも `go test ./...` のカバレッジ自体は確保できるため、「テストのしやすさ」は決定的な差分ではない。

以上を踏まえた暫定結論:

- 現時点では **「外部公開を維持する前提」にやや重心を置く**。
  - 理由: 設計意図としてドメインロジックを UI から切り出しており、将来の再利用候補が複数想定できるため。
  - ただし、まだ実際の外部コンシューマは存在しないため、「完全に安定 API」とまではみなさず、Story ベースでの仕様変更を許容する。
- 将来、`pkg/game` の API が肥大化して境界が曖昧になった場合や、逆に「ドメインロジックを別モジュールへ切り出す」方針が固まった場合は、
  - `internal` 配下への移行、
  - もしくは新規モジュール（例: `module gamecore`）への分離
  を改めて比較・検討する。

このメモは 01_再利用要件ヒアリング の入力として扱い、後続タスク（比較表/スパイク/最終決定）で前提を必要に応じて更新する。

