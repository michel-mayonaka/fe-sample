# pkg/game 可視性オプション比較メモ

作成日: 2025-11-17
ストーリー: stories/20250929-pkg-game-visibility/README.md

## 1. 比較対象

- 案A: 現状維持 — `pkg/game` を公開パッケージのまま維持
  - `pkg/game`, `pkg/game/geom`, `pkg/game/input` を含む。
- 案B: internal への移行 — `internal` 配下（例: `internal/gamecore`）へ移動
  - import パスを書き換え、モジュール外からは参照できない前提にする。

前提:

- 実際の大規模リネーム/移動は別ストーリーで行う（本ストーリーは方針決定まで）。
- 再利用要件とインポート実態は以下のメモを前提とする。
  - 再利用要件: `stories/20250929-pkg-game-visibility/requirements.md`
  - インポート棚卸し: `stories/20250929-pkg-game-visibility/import_audit.md`

## 2. 評価軸

本ストーリーでは、次の評価軸で比較する。

1. 再利用性 / 公開 API としての有用性
2. テスト容易性 / 依存の明確さ
3. 変更コスト / 将来のリファクタ自由度
4. アーキテクチャ方針との整合性（`docs/architecture/README.md`）
5. 将来の選択肢を残す柔軟性

## 3. 案A: 現状維持（pkg/game を公開パッケージのまま）

### 3-1. Pros（利点）

- 再利用性
  - 将来の CLI ツールやサーバサイド、別リポジトリから `ui_sample/pkg/game` を import して戦闘ロジックや入力ドメインを再利用できる余地を残せる。
  - `pkg/` 配下という位置付け自体が「ドメインロジック（テスト対象）であり、UI やインフラから自立した層」という設計意図と一致する。

- テスト/検証
  - 既に `pkg/game` 自体にユニットテストが存在し、`go test ./pkg/...` で単独検証できる状態を維持できる。
  - `internal/usecase` などからも同じ API を経由するため、「UI とは独立した戦闘ロジックのテスト」が継続しやすい。

- 変更コスト
  - 現状維持のため、当面のコード変更コストはゼロ。
  - 既存の import パスや Story/Docs の記述（`pkg/game` がドメインロジック層であるという説明）を変更する必要がない。

- 将来の分離容易性
  - 必要になった段階で `ui_sample` からドメイン専用モジュールを切り出す（例: `module gamecore`）際にも、`pkg/game` が公開 API として既に整理されていると移行しやすい。

### 3-2. Cons（欠点）

- API 安定性への期待
  - `pkg/` 公開パッケージとして置き続けると、「外部からも利用される前提で安定 API として守るべき」という期待が強まる。
  - 仕様変更や設計見直しを行うたびに「互換性」への配慮が必要になり、リファクタリングの心理的コストが上がる可能性がある。

- 境界の曖昧化リスク
  - `pkg/game` が膨らみすぎると、「本当に外部に見せたいドメインコア」と「このリポジトリ内だけで使う補助的な型/関数」が混在しやすい。
  - 公開/非公開の粒度を整理しないまま機能追加を続けると、将来のモジュール分割時に大きな整理コストが発生する。

## 4. 案B: internal への移行（internal/domain など）

### 4-1. Pros（利点）

- API 変更の自由度
  - `internal` 配下に移すことで、モジュール外からは参照できなくなり、「このリポジトリの内部実装」という前提で大胆なリファクタリングがしやすくなる。
  - 戦闘ロジックや入力ドメインの API を試行錯誤しながら磨きたい場合には、互換性をあまり気にせず変更できる。

- 公開面の整理
  - 「現時点ではライブラリ配布を前提にしていない」ことを明確にでき、外部利用をあえて許可しないというメッセージになる。
  - ドメインロジックのうち、本当に外部公開したい最小コアだけを別モジュールとして新設する選択肢も取りやすくなる。

### 4-2. Cons（欠点）

- 再利用性の制約
  - 別リポジトリや別モジュールから `ui_sample` の戦闘ロジックを直接再利用することができなくなる。将来 CLI/サーバ/ツールを別モジュールとして切り出す場合、改めて公開 API を設計し直す必要がある。

- 当面の移行コスト
  - `rg "ui_sample/pkg/game"` でヒットする 10 数ファイルの import パス修正が必要（Scenes/Usecase/UI/Adapter/Provider など）。
  - `pkg/game` 配下のテストのパッケージ名や import も整理し直す必要がある。
  - ドキュメント（`docs/architecture/README.md` など）で `pkg/game` を公開層として説明している箇所との整合を取り直す必要がある。

- アーキテクチャ方針とのギャップ
  - 現行の ARCHITECTURE では `pkg/game` を「ドメインロジック（テスト対象）」として公開層に置く方針が示されており、これを `internal` 化するのは方針の変更にあたる。
  - internal 化するなら、`docs/architecture/README.md` 側の方針も同時に書き換え、なぜ公開から内部専用に変えたのかを説明する必要がある。

## 5. 暫定結論と判断基準

現状の前提（外部コンシューマがまだ存在しないが、将来の再利用シナリオは複数想定される）を踏まえ、本ストーリー時点での暫定結論は次の通りとする。

- 現時点では **案A: `pkg/game` を公開パッケージとして維持** を推奨。
  - 理由:
    - `docs/architecture/README.md` がすでに `pkg/game` をドメインロジック層として位置づけており、設計意図と整合していること。
    - 戦闘ロジック・入力・幾何といった UI 非依存のコアがまとまっており、将来の CLI/サーバ/ツールからの再利用余地を確保しておきたいこと。
    - internal 化による当面のメリット（内部 API 変更の自由度）は、現時点の変更頻度や規模を考えると決定打にはなっていないこと。

- ただし、次の条件のいずれかを満たした場合は、改めて internal 移行または別モジュール分離を検討する。
  - `pkg/game` の API が大幅に増え、外部公開に適さない内部用ユーティリティが増え続けていると判断されたとき。
  - 実際に外部モジュールからの利用が発生し、「互換性維持のために設計上の負債を抱え続ける」状況になったとき。
  - 逆に、戦闘ロジックを独立モジュール（例: `module gamecore`）として切り出す計画が具体化し、その中で公開/非公開を一から設計し直すことになったとき。

## 6. 今後のアクション（他タスクへのフィードバック）

- タスク04（スパイク）
  - 実際に別モジュール or 一時的な外部プロジェクトから `ui_sample/pkg/game` を import し、ビルド・テストのしやすさを検証する。
  - ここでの体験により、「公開パッケージとしての使い勝手」が十分か、どの API が外部から見て過不足があるかを確認する。

- タスク05（最終決定とドキュメント化）
  - 本メモとスパイク結果を踏まえ、`docs/architecture/README.md` や関連ドキュメントに「`pkg/game` の可視性方針（当面は公開維持）」と「将来の見直し条件」を明文化する。

