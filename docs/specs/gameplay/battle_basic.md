# 戦闘基本仕様（system spec）

状態: impl-tested
主な実装: internal/usecase/battle.go, internal/game/scenes/ports_battle.go, pkg/game/resolve.go
最新ストーリー: 20251117-spec-status-metadata

## 1. 概要
- 機能名: 戦闘基本解決（1ラウンド）
- 目的: ステータス画面から遷移した戦闘画面で、攻撃→反撃の1ラウンドを解決し、その結果をユーザデータに永続化する。

## 2. 対象範囲
- 本仕様は「戦闘画面（簡易）」における 1 ラウンド戦闘解決を対象とする。
- 攻撃順: プレイヤー側攻撃 → 敵側反撃（条件を満たす場合）。
- 範囲外:
  - 複数ラウンド継続戦闘（追撃など）。
  - スキル/条件付き補正など高度な要素。

## 3. 用語・前提
- 攻撃側/防御側: そのラウンドで先に行動するユニットと、対象となるユニット。
- HP: `db/user/usr_characters.json` に保存される現在 HP。
- 武器威力: 使用武器に紐づく攻撃力（`mst_weapons` 相当）。
- 守備: 防御側ユニットの守備ステータス。
- ポート: 戦闘解決を担うユースケース境界 `BattlePort`。

## 4. ユースケース / シナリオ
- UC-1: ステータス画面から戦闘を開始する
  1. ユーザがステータス画面右下の「戦闘へ」を選択する。
  2. 戦闘プレビュー画面に遷移し、想定されるダメージ/結果を表示する（詳細仕様は別途検討）。
  3. ユーザが「戦闘開始」を選択すると、本仕様に従い 1 ラウンド戦闘が実行される。

- UC-2: 戦闘ラウンドの解決
  1. Scene から `BattlePort.RunBattleRound(...)` を呼び出す。
  2. Usecase 内で UI から渡されたデータをゲーム用の内部モデルへ変換し（`adapter.UIToGame`）、戦闘ロジックを実行する。
  3. 結果として HP/耐久の変化をユーザデータ `UserRepo/InventoryRepo` に反映し、永続化する。
  4. Scene は得られたログ/結果を受け取り、オーバレイ等で表示する。

## 5. 振る舞い（ロジック）

### 5.1 ダメージ計算
- 本サンプルでは、ダメージは次の簡易式で求める:
  - `攻撃 = 力 + 武器威力 - 相手守備`
- 命中判定は簡易式とし、現状は詳細仕様を規定しない（実装に依存）。
- ダメージが 0 未満になる場合は 0 とみなす（追加仕様として今後明示する）。

### 5.2 HP/耐久の更新
- 攻撃が命中した場合:
  - 防御側の HP からダメージ分を減算し、0 未満にはならないようクリップする。
  - 使用した武器/アイテムの耐久値を 1 消費する（負担するリソースは実装に依存）。
- 反撃条件を満たす場合:
  - 攻撃側/防御側を入れ替えて同様の計算を1回行う。

### 5.3 永続化
- 戦闘結果（HP/耐久）は `UserRepo` および `InventoryRepo` を通じて JSON（`db/user/*.json`）へ保存される。
- UI は Repo を直接書き換えず、必ず `BattlePort` 経由で更新を行う。

## 6. 永続化 / データ
- 関連テーブル/ファイル:
  - `db/user/usr_characters.json`: 各キャラクターの現在 HP/ステータス。
  - `db/user/usr_weapons.json` 等: 武器の残り耐久。
- 整合性:
  - 1 ラウンド戦闘の結果は 1 回のユースケース実行内で一貫して保存される（HP と耐久の更新が中途で分断されない）。

## 7. 非機能 / 制約
- 本仕様はサンプル用の簡易戦闘を対象としており、将来の拡張（複数ラウンド/スキル/地形補正など）では別 spec を追加する。

## 8. テスト観点
- 正常系:
  - 力/武器威力/守備の組み合わせでダメージが 0, 正数になるケース。
  - HP が 0 ちょうどになるケース。
  - 反撃あり/なしの両方のパターン。
- 異常/境界:
  - 非常に高い守備によりダメージが 0 未満になるケース（0 に丸められること）。
  - 武器耐久が 1 の状態で使用した場合に 0 となること。

## 9. 備考
- 命中率/クリティカル/複数回攻撃などは、別途拡張 spec で扱う予定。
- ARCHITECTURE ドキュメントでは、戦闘フロー全体の中での `BattlePort` の位置づけと、Scene との関係を説明する。
