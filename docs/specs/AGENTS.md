# SPECS/AGENTS — 仕様の読み方ガイド（エージェント向け）

この文書は、コーディングエージェントが `docs/SPECS/` 配下の仕様をどのように参照し、実装やリファクタリングに反映するかのガイドです。人間の開発者も参照できますが、特にエージェント向けの前提・優先順位を明示します。

## 1. 参照の優先順位
1. ストーリー/タスク: `stories/YYYYMMDD-slug/README.md` および `tasks/*.md`
2. 仕様: `docs/SPECS/world|gameplay|ui|reference` の該当カテゴリ
3. アーキテクチャ/命名: `docs/architecture/README.md`, `docs/KNOWLEDGE/engineering/naming.md`, `docs/KNOWLEDGE/engineering/comment-style.md`
4. その他ドキュメント: `docs/KNOWLEDGE/ops/ai-operations.md`, `docs/KNOWLEDGE/data/db-notes.md` など
5. コード本体: `cmd/`, `internal/`, `pkg/` 等

- 仕様とコードが矛盾する場合は、**まず仕様（specs）側を優先しつつ、矛盾を検出した旨をコメントで残す** ことを推奨します。
- specs に該当する情報が無い場合は、ストーリー/タスク側の意図や既存コードの挙動を尊重しつつ、必要に応じて specs へ追記できるよう提案してください。

## 2. 仕様ドキュメントの読み方
- world: `docs/SPECS/world/`
  - 世界観・マスターデータの背景設定。gameplay/ui の文脈を補完します。
- gameplay: `docs/SPECS/gameplay/`
  - ユースケースや戦闘ルールなどロジック中心の仕様。Port/Usecase の根拠になります。
- ui: `docs/SPECS/ui/`
  - 画面単位の構成・状態・入力と反応。描画や入力挙動を定義します。
- reference: `docs/SPECS/reference/`
  - API などの補助資料。コード参照時の型/メソッドの要約に使用します。

仕様に記載されていない挙動や端ケースは、勝手に拡張せず、保守的（安全側）に判断してください。

## 3. 矛盾・不明点への対応
- 仕様同士、または仕様とコードの間に矛盾を見つけた場合:
  - どのファイル・どの記述が矛盾しているかを明示したうえで、より一貫性の高い案をコメントとして提案してください。
  - 可能であれば、`stories/discovery/` に Discovery として起票することを検討してください（人間の開発者が後で整理できるようにするため）。
- 不明点が多く仕様が不足している場合:
  - 仕様を補うために必要な質問や確認事項を列挙し、ストーリー/タスク側にフィードバックしてください。

## 4. 仕様追従時の方針
- 仕様変更に伴いコードを修正する際は、**必ず関連する specs を先に更新し、そのうえでコード側を変更** してください。
- 仕様に大きな変更が入る場合は、ストーリーを切ってから対応し、`docs/SPECS/` の更新と実装を同一ストーリーで追跡できるようにします。

## 5. spec の状態メタデータ
- 各 spec ファイルの先頭付近に、次のようなメタ情報ブロックを置くことを推奨します（例）:
  - `状態: spec-only|impl-partial|impl-done|impl-tested`
  - `主な実装: internal/...`
  - `最新ストーリー: 20251117-spec-status-metadata`（最後にこの spec を編集した Story のスラグ）

- `状態` の意味（おおまかな目安）:
  - `spec-only`:
    - 仕様は記述されているが、実装/テストはまだ存在しない、または参考実装レベル。
  - `impl-partial`:
    - 仕様の一部が実装されているが、重要な振る舞いが未実装/未テストだったり、コードと仕様の差分が明確に残っている。
  - `impl-done`:
    - spec に記載された主要な振る舞いは実装されており、日常的に利用されている。テストは部分的でも構わない。
  - `impl-tested`:
    - `pkg/...` や `internal/usecase/...` 等の自動テストが、当該 spec の「テスト観点」を概ねカバーしており、`make mcp` で常に検証されている。

- 更新タイミングの目安:
  - 新しく spec を作成したとき: `状態: spec-only` で作成する。
  - 実装 Story で仕様どおりの振る舞いを実装したとき: `impl-partial` または `impl-done` へ引き上げ、`主な実装` と `最新ストーリー` を更新する。
  - テスト強化 Story で自動テストを整備したとき: 条件を満たす場合に `impl-tested` へ引き上げる。

- Story/Discovery 側では:
  - DoD に「対象 spec の `状態` をどこまで引き上げるか」を明記し、完了時に spec 側のメタ情報（`状態`/`最新ストーリー` など）を更新してください。

## 6. 今後の拡張
- `docs/SPECS/world/` の充実（勢力・クラス体系・時間軸）。
- `docs/SPECS/gameplay/` と `docs/SPECS/ui/` にテンプレートやサンプルを追加し、粒度を統一。
- `docs/SPECS/reference/` に API・テレメトリ・外部連携仕様を追加。

エージェントは、ここで定義された優先順位と方針に従って仕様を解釈し、過度な推測を避けつつ、足りない部分はストーリー/Discovery への提案という形で補完してください。
